<!DOCTYPE html>
<html>
  <head>
    <title>Parent</title>
  </head>
  <style>
    p {
      background-color: green;
    }
  </style>

  <body>
    <p>outer</p>
		<button>outer button</button>
		<label>1111</label>
		<hr/>

		<!-- <iframe src="./react2.html" frameborder="0"></iframe> -->

    <script>
      const iframe = document.createElement("iframe");
      iframe.hidden = true;
      iframe.src = "about:blank";
      document.body.appendChild(iframe);

      iframe.onload = function () {
        let oldDocument = iframe.contentWindow.document;

        // when assign function like this, you must use call/bind to restore the contenxt
        let oldIframeCreateElement =
          oldDocument.createElement.bind(oldDocument);
        let oldiframeAppendChild = oldDocument.body.appendChild.bind(
          oldDocument.body
        );

        function inject(code, frame, type) {
          const script = oldIframeCreateElement("script");
          if (type) {
            script.type = type;
          }
          script.textContent = code;
          oldiframeAppendChild(script);
        }
        function injectJsTag(src, frame, type) {
          const script = oldIframeCreateElement("script");
          if (type) {
            script.type = type;
          }
          script.src = src;
          oldiframeAppendChild(script);
        }

        // proxy iframe createElement to parent createElement
        Object.defineProperty(iframe.contentWindow.document, "createElement", {
          get() {
            return function (...args) {
              return window.parent.document.createElement(...args);
            };
          },
        });

        // proxy iframe appendChild to parent appendChild
        Object.defineProperty(
          iframe.contentWindow.document.body,
          "appendChild",
          {
            get() {
              return function (...args) {
                return window.parent.document.body.appendChild(...args);
              };
            },
          }
        );

        // TODO: no need to execute in iframe context
        const createShadowDom = `
            		  const shadowContainer = document.createElement("div");
									document.body.appendChild(shadowContainer)
									const shadowRoot = shadowContainer.attachShadow({ mode: "open" });
									const shadowStyle = document.createElement("style");
									shadowStyle.textContent = "label { color: red}";
									shadowRoot.appendChild(shadowStyle);

									const shadowContent = document.createElement("div");
									shadowContent.id ="app"
									shadowRoot.appendChild(shadowContent);
								`;

        const userJSCode = `
									import Vue from "./vue.esm.browser.js";
									new Vue({
										data: {
											counter: 0
										},
										methods: {
											incrementCounter() {
												this.counter++;
											}
										},
										render: function (createElement) {
											return createElement('div', [
												createElement('button', {
													on: {
														click: this.incrementCounter
													}
												}, 'Vue btn (click me)'),
												createElement('label', this.counter)
											]);
										}
								  }).$mount(shadowContent);

								`;

					inject(createShadowDom, iframe);
					inject(userJSCode, iframe, "module");


// react code does not execute...  maybe it's the text/babel type ???
//					const reactCode =`
//							const { useState } = React;
//
//							function App() {
//								const [counter, setCounter] = useState(0);
//
//								const incrementCounter = () => {
//									setCounter(counter + 1);
//								};
//
//								return React.createElement(
//											"div",
//											null,
//											React.createElement("button", { onClick: incrementCounter }, "React Click Me"),
//											React.createElement("label", null, counter)
//										)
//
//							}
//
//							ReactDOM.render( React.createElement(App, null) , shadowContent);
//					`
//					injectJsTag("./react.development.js",iframe)
//					injectJsTag("./react-dom.development.js",iframe)
//					inject(reactCode,iframe,'module')
      };
    </script>
  </body>
</html>
