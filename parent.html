<!DOCTYPE html>
<html>
  <head>
    <title>Parent</title>
  </head>
  <style>
    p {
      background-color: green;
    }
  </style>

  <body>
    <p>outer</p>
		<button>outer button</button>
		<label>1111</label>
		<hr/>

    <script>
      const iframe = document.createElement("iframe");
      iframe.hidden = true;
      iframe.src = "about:blank";
      document.body.appendChild(iframe);

      iframe.onload = function () {
        let oldDocument = iframe.contentWindow.document;

        // when assign function like this, you must use call/bind to restore the contenxt
        let oldIframeCreateElement =
          oldDocument.createElement.bind(oldDocument);
        let oldiframeAppendChild = oldDocument.body.appendChild.bind(
          oldDocument.body
        );

        function inject(code, frame, ismodule) {
          const script = oldIframeCreateElement("script");
          if (ismodule) {
            script.type = "module";
          }
          script.textContent = code;
          oldiframeAppendChild(script);
					script.onreadystatechange = function() {
          if (this.readyState == 'complete') {
						console.log("js injected")
          }
        }
        }
        function injectJSTag(src, frame ) {
          const script = oldIframeCreateElement("script");
          script.src = src;
          oldiframeAppendChild(script);
					script.onreadystatechange = function() {
          if (this.readyState == 'complete') {
						console.log(`js tag injected: ${src}`)
          }
        }
        }

        // proxy iframe createElement to parent createElement
        Object.defineProperty(iframe.contentWindow.document, "createElement", {
          get() {
            return function (...args) {
              return window.parent.document.createElement(...args);
            };
          },
        });

        Object.defineProperty(iframe.contentWindow.document, "getElementById", {
          get() {
            return function (...args) {
							debugger
              return window.parent.document.getElementById(...args);
            };
          },
        });
        Object.defineProperty(iframe.contentWindow.document, "querySelector", {
          get() {
            return function (selector) {
              return window.parent.document.querySelector(selector).shadowRoot.firstChild
            };
          },
        });

        // proxy iframe appendChild to parent appendChild
        Object.defineProperty(
          iframe.contentWindow.document.body,
          "appendChild",
          {
            get() {
              return function (...args) {
                return window.parent.document.body.appendChild(...args);
              };
            },
          }
        );


				const shadowContainer = document.createElement("div");
				shadowContainer.id ="app"
				document.body.appendChild(shadowContainer)
				const shadowRoot = shadowContainer.attachShadow({ mode: "open" });
				const shadowStyle = document.createElement("style");
				shadowStyle.textContent = "label { color: red}";
				shadowRoot.appendChild(shadowStyle);

				const shadowContent = document.createElement("div");
				shadowRoot.appendChild(shadowContent);

        const userJSCode = `
									import Vue from "./vue.esm.browser.js";
									new Vue({
										data: {
											counter: 0
										},
										methods: {
											incrementCounter() {
												this.counter++;
											}
										},
										render: function (createElement) {
											return createElement('div', [
												createElement('button', {
													on: {
														click: this.incrementCounter
													}
												}, 'Vue btn (click me)'),
												createElement('label', this.counter)
											]);
										}
								  }).$mount("#app");

								`;

				// TODO: wait for vue runtime to load.
				// so what is the exact timing?
				// then inject
				setTimeout(()=>{
        	inject(userJSCode, iframe, true);
				},100)
      };
    </script>
  </body>
</html>
